<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive SQL Query - Horse Riding School Revenue</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .question {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .schema {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .schema table {
            width: 100%;
            border-collapse: collapse;
            background-color: #f9f9f9;
        }
        .schema th, .schema td {
            border: 1px solid #999;
            padding: 8px;
            text-align: left;
        }
        .schema th {
            background-color: #d3d3d3;
        }
        .schema tr:nth-child(even) {
            background-color: #f0f0f0;
        }
        .schema tr:nth-child(odd) {
            background-color: #fff;
        }
        .cm-editor {
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
            height: 400px;
            background-color: #1e1e1e;
        }

        /* Dark theme for SQL editor */
        .cm-editor .cm-content {
            background-color: #1e1e1e;
            color: #d4d4d4;
        }

        .cm-editor .cm-focused {
            outline: none;
        }

        .editor-container {
            border: 1px solid #444;
            border-radius: 5px;
            background-color: #1e1e1e;
        }

        .editor-results-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .editor-panel {
            flex: 1;
            min-width: 0; /* Allows flex item to shrink below content size */
        }

        .results-panel {
            flex: 1;
            min-width: 0;
        }

        .panel-header {
            color: #555;
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: bold;
        }

        .button-container {
            margin: 10px 0;
        }
        .run-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .run-btn:hover {
            background-color: #45a049;
        }
        .results {
            margin-top: 0;
            min-height: 400px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #fafafa;
            overflow-y: auto;
        }
        .results table {
            width: 100%;
            border-collapse: collapse;
            background-color: #f9f9f9;
        }
        .results th, .results td {
            border: 1px solid #999;
            padding: 8px;
            text-align: left;
        }
        .results th {
            background-color: #d3d3d3;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
        .success {
            color: green;
            margin-top: 10px;
        }
        .copy-instructions {
            margin-top: 10px;
            font-style: italic;
        }

        /* Responsive design for smaller screens */
        @media (max-width: 768px) {
            .editor-results-container {
                flex-direction: column;
            }

            .cm-editor {
                height: 300px;
            }

            .results {
                min-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h3 style="color: #555; margin-top: 0;">Bonus: Interactive SQL Query - Horse Riding School Revenue (15 points)</h3>
        <div class="question">
            <p style="margin: 10px 0;">Write a SQL query to find the total revenue generated by each horse (sum of PricePerLesson for all scheduled lessons). Include the horse's RegisteredName and the total_revenue, ordered by total_revenue descending. Horses with no lessons should show 0 revenue. Run your query below, verify the results, and copy your query for submission in the separate question form.</p>
        </div>
        <div class="schema">
            <h4 style="color: #555; margin-top: 0;">Schema and Sample Data</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                <div style="flex: 1; min-width: 300px;">
                    <h4 style="color: #555; margin-top: 0;">Horse</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>HorseID</th>
                                <th>RegisteredName</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>1</td><td>Thunder</td></tr>
                            <tr><td>2</td><td>Lightning</td></tr>
                            <tr><td>3</td><td>Storm</td></tr>
                        </tbody>
                    </table>
                </div>
                <div style="flex: 1; min-width: 300px;">
                    <h4 style="color: #555; margin-top: 0;">LessonSchedule</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>HorseID</th>
                                <th>StudentID</th>
                                <th>LessonDateTime</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>1</td><td>1</td><td>2024-02-01 10:00</td></tr>
                            <tr><td>2</td><td>2</td><td>2024-02-01 11:00</td></tr>
                            <tr><td>1</td><td>3</td><td>2024-02-01 14:00</td></tr>
                        </tbody>
                    </table>
                </div>
                <div style="flex: 1; min-width: 300px;">
                    <h4 style="color: #555; margin-top: 0;">LessonPricing</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>HorseID</th>
                                <th>PricePerLesson</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>1</td><td>75.00</td></tr>
                            <tr><td>2</td><td>85.00</td></tr>
                            <tr><td>3</td><td>70.00</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="editor-results-container">
            <div class="editor-panel">
                <h4 class="panel-header">SQL Query Editor</h4>
                <div id="sql-editor" class="editor-container"></div>
                <div class="button-container">
                    <button class="run-btn" onclick="runQuery()">Run Query</button>
                    <button class="run-btn" onclick="formatSQL()" style="background-color: #2196F3; margin-left: 10px;">Format SQL</button>
                </div>
            </div>
            <div class="results-panel">
                <h4 class="panel-header">Query Results</h4>
                <div id="results" class="results"></div>
            </div>
        </div>
        <p class="copy-instructions">After verifying your results, copy your query from the editor and paste it into the submission form for grading.</p>
    </div>

    <script type="module">
        import { EditorView, basicSetup } from 'https://esm.sh/codemirror@6.0.1';
        import { sql, PostgreSQL, keywordCompletionSource } from 'https://esm.sh/@codemirror/lang-sql@6.5.4';
        import { oneDark } from 'https://esm.sh/@codemirror/theme-one-dark@6.1.2';
        import { autocompletion, startCompletion, acceptCompletion, completionKeymap } from 'https://esm.sh/@codemirror/autocomplete@6.10.2';
        import { keymap } from 'https://esm.sh/@codemirror/view@6.21.3';
        import { indentWithTab } from 'https://esm.sh/@codemirror/commands@6.3.0';
        import { EditorState } from 'https://esm.sh/@codemirror/state@6.3.1';

        let db;
        let editor;

        // Custom SQL keyword completion source
        function sqlKeywordCompletion(context) {
            const keywords = [
                'SELECT', 'FROM', 'WHERE', 'GROUP BY', 'HAVING', 'ORDER BY', 'LIMIT', 'OFFSET',
                'INSERT', 'INTO', 'VALUES', 'UPDATE', 'SET', 'DELETE', 'CREATE', 'TABLE', 'ALTER', 'DROP',
                'INNER JOIN', 'LEFT JOIN', 'RIGHT JOIN', 'FULL JOIN', 'CROSS JOIN', 'JOIN', 'ON',
                'UNION', 'UNION ALL', 'INTERSECT', 'EXCEPT', 'WITH', 'AS', 'DISTINCT', 'ALL',
                'AND', 'OR', 'NOT', 'IN', 'EXISTS', 'BETWEEN', 'LIKE', 'ILIKE', 'IS', 'NULL',
                'CASE', 'WHEN', 'THEN', 'ELSE', 'END', 'IF', 'COALESCE', 'NULLIF',
                'COUNT', 'SUM', 'AVG', 'MIN', 'MAX', 'ROUND', 'UPPER', 'LOWER', 'TRIM',
                'VARCHAR', 'INTEGER', 'DECIMAL', 'DATE', 'TIMESTAMP', 'BOOLEAN', 'TEXT', 'REAL',
                'PRIMARY KEY', 'FOREIGN KEY', 'REFERENCES', 'UNIQUE', 'INDEX', 'CONSTRAINT',
                'TRUE', 'FALSE', 'ASC', 'DESC'
            ];

            const word = context.matchBefore(/\w*/);
            if (!word || (word.from === word.to && !context.explicit)) return null;

            return {
                from: word.from,
                options: keywords.map(keyword => ({
                    label: keyword,
                    type: "keyword",
                    boost: 99
                }))
            };
        }

        async function initDB() {
            try {
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
                });
                db = new SQL.Database();

                // Create tables
                db.run(`
                    CREATE TABLE Horse (
                        HorseID INTEGER PRIMARY KEY,
                        RegisteredName TEXT
                    );
                    CREATE TABLE LessonSchedule (
                        HorseID INTEGER,
                        StudentID INTEGER,
                        LessonDateTime TEXT
                    );
                    CREATE TABLE LessonPricing (
                        HorseID INTEGER PRIMARY KEY,
                        PricePerLesson REAL
                    );
                `);

                // Insert data
                db.run(`
                    INSERT INTO Horse (HorseID, RegisteredName) VALUES
                        (1, 'Thunder'),
                        (2, 'Lightning'),
                        (3, 'Storm');
                    INSERT INTO LessonSchedule (HorseID, StudentID, LessonDateTime) VALUES
                        (1, 1, '2024-02-01 10:00'),
                        (2, 2, '2024-02-01 11:00'),
                        (1, 3, '2024-02-01 14:00');
                    INSERT INTO LessonPricing (HorseID, PricePerLesson) VALUES
                        (1, 75.00),
                        (2, 85.00),
                        (3, 70.00);
                `);

                console.log("Database initialized successfully");
            } catch (error) {
                console.error("Error initializing database:", error);
            }
        }

        function initEditor() {
            // Initial SQL content
            const startDoc = `-- Write your SQL query here
-- Example: Find total revenue by horse
SELECT h.RegisteredName
FROM Horse h;`;

            // Initialize CodeMirror 6 Editor with proper SQL support
            editor = new EditorView({
                doc: startDoc,
                extensions: [
                    basicSetup,
                    sql({
                        dialect: PostgreSQL,
                        upperCaseKeywords: false,
                        schema: {
                            // Schema for autocompletion
                            Horse: ["HorseID", "RegisteredName"],
                            LessonSchedule: ["HorseID", "StudentID", "LessonDateTime"],
                            LessonPricing: ["HorseID", "PricePerLesson"]
                        }
                    }),
                    oneDark,
                    autocompletion({
                        activateOnTyping: true,
                        closeOnBlur: false,
                        maxRenderedOptions: 15,
                        defaultKeymap: true,
                        override: [
                            sqlKeywordCompletion,
                            keywordCompletionSource(PostgreSQL, false)
                        ]
                    }),
                    keymap.of([
                        {
                            key: 'Ctrl-Space',
                            run: startCompletion
                        },
                        {
                            key: 'Ctrl-Enter',
                            run: acceptCompletion
                        },
                        {
                            key: 'Tab',
                            run: (view) => {
                                // Try completion first, then indent
                                const completionState = view.state.field(autocompletion.state, false);
                                if (completionState?.open) {
                                    return acceptCompletion(view);
                                }
                                return indentWithTab(view);
                            }
                        },
                        {
                            key: 'Enter',
                            run: (view) => {
                                // Accept completion if open, otherwise normal enter
                                const completionState = view.state.field(autocompletion.state, false);
                                if (completionState?.open) {
                                    return acceptCompletion(view);
                                }
                                return false; // Let default Enter behavior handle it
                            }
                        }
                    ]),
                    keymap.of(completionKeymap),
                ],
                parent: document.getElementById('sql-editor')
            });
        }

        // Advanced SQL formatter with proper multi-line support
        function formatSQL() {
            const sql = editor.state.doc.toString();
            if (!sql.trim()) return;

            // Advanced SQL formatting with proper multi-line handling
            let formatted = sql
                // Normalize whitespace but preserve structure
                .replace(/\s+/g, ' ')
                .trim();

            // Add line breaks before major SQL keywords
            formatted = formatted
                .replace(/\b(SELECT|FROM|WHERE|GROUP\s+BY|HAVING|ORDER\s+BY|UNION|UNION\s+ALL|EXCEPT|INTERSECT)\b/gi, '\n$1')
                .replace(/\b(INSERT\s+INTO|UPDATE|DELETE\s+FROM|CREATE|ALTER|DROP)\b/gi, '\n$1')
                .replace(/\b(INNER\s+JOIN|LEFT\s+JOIN|LEFT\s+OUTER\s+JOIN|RIGHT\s+JOIN|RIGHT\s+OUTER\s+JOIN|FULL\s+JOIN|FULL\s+OUTER\s+JOIN|CROSS\s+JOIN|JOIN)\b/gi, '\n$1')
                .replace(/\b(CASE|WHEN|THEN|ELSE|END)\b/gi, '\n$1')
                .replace(/\b(WITH|AS)\s*\(/gi, '\n$1 (');

            // Handle subqueries and parentheses
            formatted = formatted
                .replace(/\(\s*(SELECT)/gi, '(\n    $1')
                .replace(/\)\s*(AS|,|\s*$)/gi, '\n)$1');

            // Add line breaks after commas in SELECT, INSERT, etc.
            formatted = formatted
                .replace(/,(\s*)(?=\w)/g, ',\n')
                .replace(/,(\s*)(?=\()/g, ',\n');

            // Clean up and split into lines
            const lines = formatted
                .replace(/\n\s*\n/g, '\n') // Remove empty lines
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            // Apply intelligent indentation
            let indentLevel = 0;
            let inSubquery = 0;
            const indentedLines = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const prevLine = i > 0 ? lines[i - 1] : '';
                const nextLine = i < lines.length - 1 ? lines[i + 1] : '';

                // Handle closing parentheses first
                if (line.startsWith(')')) {
                    inSubquery = Math.max(0, inSubquery - 1);
                    indentLevel = Math.max(0, indentLevel - 1);
                }

                let currentIndent = indentLevel + inSubquery;

                // Main SQL keywords start at base level
                if (/^(SELECT|INSERT\s+INTO|UPDATE|DELETE\s+FROM|CREATE|ALTER|DROP|WITH)\b/i.test(line)) {
                    currentIndent = inSubquery;
                }
                // FROM, WHERE, etc. at base level
                else if (/^(FROM|WHERE|GROUP\s+BY|HAVING|ORDER\s+BY|UNION|UNION\s+ALL|EXCEPT|INTERSECT)\b/i.test(line)) {
                    currentIndent = inSubquery;
                }
                // JOINs at base level
                else if (/^(INNER\s+JOIN|LEFT\s+JOIN|LEFT\s+OUTER\s+JOIN|RIGHT\s+JOIN|RIGHT\s+OUTER\s+JOIN|FULL\s+JOIN|FULL\s+OUTER\s+JOIN|CROSS\s+JOIN|JOIN)\b/i.test(line)) {
                    currentIndent = inSubquery;
                }
                // AND/OR conditions indented
                else if (/^(AND|OR)\b/i.test(line)) {
                    currentIndent = inSubquery + 1;
                }
                // CASE statements
                else if (/^(CASE|WHEN|THEN|ELSE)\b/i.test(line)) {
                    if (/^CASE\b/i.test(line)) {
                        currentIndent = inSubquery + 1;
                    } else {
                        currentIndent = inSubquery + 2;
                    }
                }
                else if (/^END\b/i.test(line)) {
                    currentIndent = inSubquery + 1;
                }
                // Column lists and values
                else if (line.startsWith(',') || (prevLine && /^(SELECT|INSERT\s+INTO.*\(|VALUES)\b/i.test(prevLine))) {
                    currentIndent = inSubquery + 1;
                }
                // Default indentation for continuation lines
                else if (prevLine && !(/^(SELECT|FROM|WHERE|GROUP\s+BY|HAVING|ORDER\s+BY|UNION|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP|JOIN|INNER|LEFT|RIGHT|FULL|CROSS)\b/i.test(line))) {
                    currentIndent = inSubquery + 1;
                }

                // Add the indented line
                indentedLines.push('    '.repeat(Math.max(0, currentIndent)) + line);

                // Handle opening parentheses for subqueries
                if (line.includes('(') && /SELECT\b/i.test(line)) {
                    inSubquery++;
                    indentLevel++;
                }
            }

            const formattedSQL = indentedLines.join('\n');

            editor.dispatch({
                changes: {
                    from: 0,
                    to: editor.state.doc.length,
                    insert: formattedSQL
                }
            });
        }

        window.runQuery = function() {
            const resultsDiv = document.getElementById("results");
            resultsDiv.innerHTML = '';

            if (!db) {
                resultsDiv.innerHTML = '<div class="error">Database not initialized yet. Please wait a moment and try again.</div>';
                return;
            }

            try {
                const query = editor.state.doc.toString();
                console.log("Executing query:", query);

                const results = db.exec(query);
                if (results.length > 0) {
                    const table = document.createElement('table');
                    const thead = document.createElement('thead');
                    const tbody = document.createElement('tbody');
                    const headerRow = document.createElement('tr');

                    results[0].columns.forEach(col => {
                        const th = document.createElement('th');
                        th.textContent = col;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);

                    results[0].values.forEach(row => {
                        const tr = document.createElement('tr');
                        row.forEach(val => {
                            const td = document.createElement('td');
                            td.textContent = val !== null ? val : 'NULL';
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });

                    table.appendChild(thead);
                    table.appendChild(tbody);
                    resultsDiv.appendChild(table);
                    resultsDiv.insertAdjacentHTML('beforeend', '<div class="success">Query executed successfully!</div>');
                } else {
                    resultsDiv.innerHTML = '<div class="success">Query executed successfully, but no results returned.</div>';
                }

                resultsDiv.insertAdjacentHTML('beforeend', `<p><strong>Your Query:</strong></p><pre style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto;">${query}</pre>`);
            } catch (err) {
                console.error("Query error:", err);
                resultsDiv.innerHTML = `<div class="error">Error: ${err.message}</div>`;
            }
        };

        // Make formatSQL available globally
        window.formatSQL = formatSQL;

        // Initialize everything
        initDB().then(initEditor);
    </script>
</body>
</html>